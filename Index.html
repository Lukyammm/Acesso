<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Institucional</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --primary: #3877ff;
      --primary-dark: #215de2;
      --surface-glass: rgba(255, 255, 255, 0.62);
      --surface-glass-strong: rgba(255, 255, 255, 0.76);
      --stroke-glass: rgba(255, 255, 255, 0.52);
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.09);
      --shadow-strong: 0 24px 60px rgba(15, 23, 42, 0.16);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at 12% 18%, rgba(56, 119, 255, 0.28), transparent 42%),
        radial-gradient(circle at 86% 14%, rgba(124, 58, 237, 0.18), transparent 38%),
        radial-gradient(circle at 50% 92%, rgba(13, 148, 136, 0.16), transparent 44%),
        linear-gradient(180deg, #f6f8fc 0%, #eef2f9 100%);
      color: var(--text-primary);
    }

    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 72px;
      background: var(--surface-glass-strong);
      backdrop-filter: blur(22px) saturate(150%);
      border-bottom: 1px solid var(--stroke-glass);
      display: flex; align-items: center; padding: 0 32px; z-index: 1000;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
    }
    .logo { font-size: 1.4rem; font-weight: 700; }
    .tabs { display: flex; gap: 8px; margin-left: 52px; }
    .tab {
      padding: 10px 20px; border-radius: 9999px; font-weight: 600; cursor: pointer;
      color: var(--text-secondary);
    }
    .tab:hover { background: rgba(148, 163, 184, 0.15); }
    .tab.active {
      background: linear-gradient(135deg, var(--primary) 0%, #6998ff 100%);
      color: white;
    }
    .user { margin-left: auto; color: var(--text-secondary); font-weight: 500; }

    .sidebar {
      position: fixed; left: 0; top: 72px; bottom: 0; width: 292px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(26px) saturate(135%);
      color: #d8e0eb; padding: 28px 0; overflow-y: auto;
      border-right: 1px solid rgba(255, 255, 255, 0.18);
    }
    .sidebar-header { padding: 0 28px 18px; color: #9aa9be; font-size: 0.78rem; font-weight: 600; letter-spacing: 1.2px; }
    .sidebar-item {
      margin: 0 12px;
      padding: 14px 16px; display: flex; align-items: center; gap: 14px;
      border-radius: 14px;
      cursor: pointer;
    }
    .sidebar-item:hover, .sidebar-item.active { background: rgba(255, 255, 255, 0.12); color: white; }

    .main { margin-left: 292px; padding: 92px 36px 36px; min-height: 100vh; }
    .hidden { display: none; }

    .accordion {
      background: var(--surface-glass); border-radius: 20px; overflow: hidden;
      border: 1px solid var(--stroke-glass);
      box-shadow: var(--shadow-soft); margin-bottom: 16px;
    }
    .accordion summary {
      padding: 20px 24px; font-weight: 600; font-size: 1.05rem;
      cursor: pointer; display: flex; align-items: center; gap: 12px;
      background: rgba(255, 255, 255, 0.42); list-style: none;
    }
    .accordion summary::-webkit-details-marker { display: none; }
    .chevron { margin-left: auto; }
    .items-container { padding: 12px 20px 20px; }

    .item {
      display: flex; align-items: center; gap: 12px;
      padding: 14px; border-radius: 12px; margin-bottom: 8px;
      border: 1px solid #dbe3ee; background: rgba(255, 255, 255, 0.75);
    }
    .item i { width: 24px; color: #64748b; }

    .panel {
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid #dbe3ee;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
    }
    .panel h3 { margin-bottom: 12px; font-size: 1.1rem; }

    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 0.85rem; color: #475569; font-weight: 600; }
    .field input, .field select, .field textarea {
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
      font-size: 0.95rem;
      background: white;
    }

    .btn {
      border: none; border-radius: 10px;
      padding: 10px 14px; font-weight: 600; cursor: pointer;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #64748b; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-light { background: #e2e8f0; color: #0f172a; }
    .btn-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    .list {
      border: 1px solid #dbe3ee;
      border-radius: 10px;
      max-height: 220px;
      overflow: auto;
      background: #fff;
    }
    .list-item {
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.92rem;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item.active { background: #eff6ff; }
    .muted { color: #64748b; font-size: 0.9rem; }

    .modal {
      display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.42);
      align-items: center; justify-content: center; z-index: 3000;
    }
    .modal-content {
      background: #fff;
      border-radius: 16px; width: 90%; max-width: 680px;
      max-height: 88vh; overflow: hidden;
    }
    .modal-header {
      padding: 16px 20px; border-bottom: 1px solid #e2e8f0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .close-btn { border: none; background: none; font-size: 28px; cursor: pointer; }
    .modal-body { padding: 20px; max-height: 65vh; overflow-y: auto; }
    .modal-body a {
      display: block; padding: 12px; margin: 6px 0;
      border: 1px solid #dbe3ee; border-radius: 8px;
      text-decoration: none; color: inherit;
    }

    @media (max-width: 980px) {
      .sidebar { position: static; width: auto; height: auto; }
      .main { margin-left: 0; padding-top: 16px; }
      .topbar { position: static; }
      .grid, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">PORTAL INSTITUCIONAL</div>
    <div class="tabs">
      <div class="tab active" onclick="switchTab(0)">Dashboard</div>
      <div class="tab" id="adminTab" onclick="enterAdmin()">Administra√ß√£o</div>
    </div>
    <div class="user" id="user">Carregando...</div>
  </div>

  <div class="sidebar" id="sidebar"></div>

  <div class="main" id="dashboardView">
    <h1 id="categoryTitle"></h1>
    <div id="dashboardContent"></div>
  </div>

  <div class="main hidden" id="adminView">
    <h1 style="margin-bottom:6px;">Administra√ß√£o do Portal</h1>
    <p class="muted" style="margin-bottom: 16px;">Cadastro guiado para categorias, se√ß√µes e itens.</p>

    <div class="panel">
      <h3>Configura√ß√£o Geral</h3>
      <div class="grid">
        <div class="field">
          <label>Nome do portal</label>
          <input id="appNameInput" type="text">
        </div>
        <div class="field">
          <label>Cor principal</label>
          <input id="primaryColorInput" type="text" placeholder="#1e40af">
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Categorias</h3>
      <div class="grid">
        <div>
          <div class="list" id="categoryList"></div>
        </div>
        <div>
          <div class="field"><label>Nome</label><input id="catName" type="text"></div>
          <div class="field"><label>√çcone (FontAwesome)</label><input id="catIcon" type="text" placeholder="fa-folder"></div>
          <div class="field"><label>Cor</label><input id="catColor" type="text" placeholder="#1e40af"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveCategory()">Salvar Categoria</button>
            <button class="btn btn-danger" onclick="deleteCategory()">Excluir</button>
            <button class="btn btn-light" onclick="newCategory()">Nova</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Se√ß√µes da Categoria</h3>
      <div class="grid">
        <div>
          <div class="list" id="subtopicList"></div>
        </div>
        <div>
          <div class="field"><label>T√≠tulo</label><input id="subTitle" type="text"></div>
          <div class="field"><label>√çcone (FontAwesome)</label><input id="subIcon" type="text" placeholder="fa-link"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveSubtopic()">Salvar Se√ß√£o</button>
            <button class="btn btn-danger" onclick="deleteSubtopic()">Excluir</button>
            <button class="btn btn-light" onclick="newSubtopic()">Nova</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Itens da Se√ß√£o</h3>
      <div class="grid">
        <div>
          <div class="list" id="itemList"></div>
        </div>
        <div>
          <div class="field"><label>Nome</label><input id="itemName" type="text"></div>
          <div class="field"><label>Descri√ß√£o</label><input id="itemDesc" type="text"></div>
          <div class="field">
            <label>Tipo</label>
            <select id="itemType" onchange="toggleItemFields()">
              <option value="link">Link</option>
              <option value="sheet">Planilha</option>
              <option value="folder">Pasta Drive</option>
            </select>
          </div>
          <div class="field" id="urlField"><label>URL</label><input id="itemUrl" type="text"></div>
          <div class="field hidden" id="folderField"><label>ID da Pasta</label><input id="itemFolderId" type="text"></div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveItem()">Salvar Item</button>
            <button class="btn btn-danger" onclick="deleteItem()">Excluir</button>
            <button class="btn btn-light" onclick="newItem()">Novo</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Salvar / Hist√≥rico</h3>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="saveAllAdmin()">Salvar tudo</button>
        <button class="btn btn-secondary" onclick="reloadAdminData()">Recarregar</button>
        <button class="btn btn-danger" onclick="restoreDefault()">Restaurar padr√£o</button>
        <button class="btn btn-light" onclick="undoLastChange()">Desfazer √∫ltima altera√ß√£o</button>
      </div>
      <div style="margin-top:12px" class="list" id="auditList"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    let currentConfig = {};
    let adminDraft = null;
    let currentCategoryId = null;
    let isAdmin = false;

    let selectedCategoryId = null;
    let selectedSubtopicId = null;
    let selectedItemIndex = -1;

    function switchTab(n) {
      document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === n));
      document.getElementById('dashboardView').style.display = n === 0 ? 'block' : 'none';
      document.getElementById('adminView').classList.toggle('hidden', n !== 1);
    }

    function enterAdmin() {
      if (!isAdmin) {
        alert('Acesso restrito a administradores.');
        return;
      }
      switchTab(1);
      fillAdminScreen();
    }

    function loadInitialData() {
      google.script.run.withSuccessHandler(data => {
        isAdmin = !!data.isAdmin;
        currentConfig = data.config;
        adminDraft = JSON.parse(JSON.stringify(data.config));

        document.getElementById('user').innerHTML = `üë§ ${data.email || 'Usu√°rio'}`;
        if (!isAdmin) {
          document.getElementById('adminTab').style.display = 'none';
        }

        loadDashboard();
        if (isAdmin) {
          loadAudit();
        }
      }).getAdminData();
    }

    function loadDashboard() {
      renderSidebar();
      if (currentConfig.categories && currentConfig.categories.length) {
        loadCategory(currentConfig.categories[0].id);
      } else {
        document.getElementById('categoryTitle').textContent = 'Sem categorias';
        document.getElementById('dashboardContent').innerHTML = '';
      }
    }

    function renderSidebar() {
      const sb = document.getElementById('sidebar');
      sb.innerHTML = '<div class="sidebar-header">CATEGORIAS</div>';
      (currentConfig.categories || []).forEach(cat => {
        const div = document.createElement('div');
        div.className = 'sidebar-item';
        div.innerHTML = `<i class="fas ${cat.icon}"></i><span>${cat.name}</span>`;
        div.onclick = () => loadCategory(cat.id);
        sb.appendChild(div);
      });
    }

    function loadCategory(catId) {
      currentCategoryId = catId;
      const cat = (currentConfig.categories || []).find(c => c.id === catId);
      if (!cat) return;

      document.getElementById('categoryTitle').innerHTML = `<span style="color:${cat.color}">${cat.name}</span>`;

      let html = '';
      (cat.subtopics || []).forEach(sub => {
        html += `
          <details class="accordion">
            <summary>
              <i class="fas ${sub.icon}"></i>
              <span>${sub.title}</span>
              <i class="fas fa-chevron-down chevron"></i>
            </summary>
            <div class="items-container">`;

        if (!sub.items || sub.items.length === 0) {
          html += `<p class="muted" style="padding:20px;text-align:center;">Nenhum item ainda.</p>`;
        } else {
          sub.items.forEach(item => {
            const icon = item.type === 'folder' ? 'fa-folder-open' : item.type === 'sheet' ? 'fa-file-excel' : 'fa-link';
            html += `
              <div class="item">
                <i class="fas ${icon}"></i>
                <div style="flex:1;">
                  <div style="font-weight:600;">${item.name}</div>
                  ${item.desc ? `<div class="muted">${item.desc}</div>` : ''}
                </div>
                ${item.type === 'folder'
                  ? `<button class="btn btn-primary" onclick="openFolder('${item.folderId}','${item.name}')">Ver Pasta</button>`
                  : `<button class="btn btn-primary" onclick="window.open('${item.url}','_blank')">Abrir</button>`
                }
              </div>`;
          });
        }

        html += '</div></details>';
      });

      document.getElementById('dashboardContent').innerHTML = html;
    }

    function openFolder(folderId, title) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = '<p class="muted">Carregando...</p>';
      document.getElementById('modal').style.display = 'flex';

      google.script.run
        .withSuccessHandler(items => {
          let list = '';
          items.forEach(it => {
            list += `<a href="${it.url}" target="_blank">${it.name}</a>`;
          });
          document.getElementById('modalBody').innerHTML = list || '<p class="muted">Pasta vazia.</p>';
        })
        .withFailureHandler(() => {
          document.getElementById('modalBody').innerHTML = '<p style="color:#dc2626;">Erro ao carregar pasta.</p>';
        })
        .getDriveFolderContents(folderId);
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function fillAdminScreen() {
      if (!adminDraft) return;

      document.getElementById('appNameInput').value = adminDraft.appName || '';
      document.getElementById('primaryColorInput').value = adminDraft.primaryColor || '';

      if (!selectedCategoryId && adminDraft.categories.length) {
        selectedCategoryId = adminDraft.categories[0].id;
      }

      renderCategoryList();
      renderSubtopicList();
      renderItemList();
      fillCategoryForm();
      fillSubtopicForm();
      fillItemForm();
      toggleItemFields();
    }

    function getSelectedCategory() {
      return (adminDraft.categories || []).find(c => c.id === selectedCategoryId);
    }

    function getSelectedSubtopic() {
      const category = getSelectedCategory();
      if (!category) return null;
      return (category.subtopics || []).find(s => s.id === selectedSubtopicId);
    }

    function renderCategoryList() {
      const el = document.getElementById('categoryList');
      const list = adminDraft.categories || [];
      el.innerHTML = list.map(c => `
        <div class="list-item ${c.id === selectedCategoryId ? 'active' : ''}" onclick="selectCategory('${c.id}')">
          <span>${c.name}</span>
          <span class="muted">${c.id}</span>
        </div>
      `).join('') || '<div class="list-item">Sem categorias</div>';
    }

    function renderSubtopicList() {
      const el = document.getElementById('subtopicList');
      const cat = getSelectedCategory();
      if (!cat) {
        el.innerHTML = '<div class="list-item">Selecione uma categoria</div>';
        return;
      }

      if (!selectedSubtopicId && cat.subtopics.length) {
        selectedSubtopicId = cat.subtopics[0].id;
      }

      el.innerHTML = cat.subtopics.map(s => `
        <div class="list-item ${s.id === selectedSubtopicId ? 'active' : ''}" onclick="selectSubtopic('${s.id}')">
          <span>${s.title}</span>
          <span class="muted">${s.id}</span>
        </div>
      `).join('') || '<div class="list-item">Sem se√ß√µes</div>';
    }

    function renderItemList() {
      const el = document.getElementById('itemList');
      const sub = getSelectedSubtopic();
      if (!sub) {
        el.innerHTML = '<div class="list-item">Selecione uma se√ß√£o</div>';
        return;
      }

      if (selectedItemIndex >= sub.items.length) {
        selectedItemIndex = -1;
      }

      el.innerHTML = sub.items.map((it, idx) => `
        <div class="list-item ${idx === selectedItemIndex ? 'active' : ''}" onclick="selectItem(${idx})">
          <span>${it.name}</span>
          <span class="muted">${it.type}</span>
        </div>
      `).join('') || '<div class="list-item">Sem itens</div>';
    }

    function selectCategory(id) {
      selectedCategoryId = id;
      selectedSubtopicId = null;
      selectedItemIndex = -1;
      fillAdminScreen();
    }

    function selectSubtopic(id) {
      selectedSubtopicId = id;
      selectedItemIndex = -1;
      fillAdminScreen();
    }

    function selectItem(index) {
      selectedItemIndex = index;
      fillItemForm();
    }

    function fillCategoryForm() {
      const cat = getSelectedCategory();
      document.getElementById('catName').value = cat ? cat.name : '';
      document.getElementById('catIcon').value = cat ? cat.icon : 'fa-folder';
      document.getElementById('catColor').value = cat ? cat.color : '#1e40af';
    }

    function fillSubtopicForm() {
      const sub = getSelectedSubtopic();
      document.getElementById('subTitle').value = sub ? sub.title : '';
      document.getElementById('subIcon').value = sub ? sub.icon : 'fa-link';
    }

    function fillItemForm() {
      const sub = getSelectedSubtopic();
      if (!sub || selectedItemIndex < 0 || !sub.items[selectedItemIndex]) {
        document.getElementById('itemName').value = '';
        document.getElementById('itemDesc').value = '';
        document.getElementById('itemType').value = 'link';
        document.getElementById('itemUrl').value = '';
        document.getElementById('itemFolderId').value = '';
        toggleItemFields();
        return;
      }

      const item = sub.items[selectedItemIndex];
      document.getElementById('itemName').value = item.name || '';
      document.getElementById('itemDesc').value = item.desc || '';
      document.getElementById('itemType').value = item.type || 'link';
      document.getElementById('itemUrl').value = item.url || '';
      document.getElementById('itemFolderId').value = item.folderId || '';
      toggleItemFields();
    }

    function newCategory() {
      selectedCategoryId = null;
      fillCategoryForm();
    }

    function saveCategory() {
      const name = document.getElementById('catName').value.trim();
      const icon = document.getElementById('catIcon').value.trim() || 'fa-folder';
      const color = document.getElementById('catColor').value.trim() || '#1e40af';

      if (!name) return alert('Informe o nome da categoria.');

      if (selectedCategoryId) {
        const cat = getSelectedCategory();
        cat.name = name;
        cat.icon = icon;
        cat.color = color;
      } else {
        const id = slugify(name + '-' + Date.now());
        adminDraft.categories.push({ id, name, icon, color, subtopics: [] });
        selectedCategoryId = id;
      }

      fillAdminScreen();
    }

    function deleteCategory() {
      if (!selectedCategoryId) return;
      if (!confirm('Excluir categoria selecionada?')) return;

      adminDraft.categories = adminDraft.categories.filter(c => c.id !== selectedCategoryId);
      selectedCategoryId = adminDraft.categories.length ? adminDraft.categories[0].id : null;
      selectedSubtopicId = null;
      selectedItemIndex = -1;
      fillAdminScreen();
    }

    function newSubtopic() {
      selectedSubtopicId = null;
      fillSubtopicForm();
    }

    function saveSubtopic() {
      const cat = getSelectedCategory();
      if (!cat) return alert('Selecione uma categoria.');

      const title = document.getElementById('subTitle').value.trim();
      const icon = document.getElementById('subIcon').value.trim() || 'fa-link';
      if (!title) return alert('Informe o t√≠tulo da se√ß√£o.');

      if (selectedSubtopicId) {
        const sub = getSelectedSubtopic();
        sub.title = title;
        sub.icon = icon;
      } else {
        const id = slugify(title + '-' + Date.now());
        cat.subtopics.push({ id, title, icon, items: [] });
        selectedSubtopicId = id;
      }

      fillAdminScreen();
    }

    function deleteSubtopic() {
      const cat = getSelectedCategory();
      if (!cat || !selectedSubtopicId) return;
      if (!confirm('Excluir se√ß√£o selecionada?')) return;

      cat.subtopics = cat.subtopics.filter(s => s.id !== selectedSubtopicId);
      selectedSubtopicId = cat.subtopics.length ? cat.subtopics[0].id : null;
      selectedItemIndex = -1;
      fillAdminScreen();
    }

    function newItem() {
      selectedItemIndex = -1;
      fillItemForm();
    }

    function saveItem() {
      const sub = getSelectedSubtopic();
      if (!sub) return alert('Selecione uma se√ß√£o.');

      const name = document.getElementById('itemName').value.trim();
      const desc = document.getElementById('itemDesc').value.trim();
      const type = document.getElementById('itemType').value;
      const url = document.getElementById('itemUrl').value.trim();
      const folderId = document.getElementById('itemFolderId').value.trim();

      if (!name) return alert('Informe o nome do item.');
      if (type === 'folder' && !folderId) return alert('Informe o ID da pasta.');
      if (type !== 'folder' && !url) return alert('Informe a URL.');

      const payload = { name, desc, type, url: type === 'folder' ? '' : url, folderId: type === 'folder' ? folderId : '' };

      if (selectedItemIndex >= 0 && sub.items[selectedItemIndex]) {
        sub.items[selectedItemIndex] = payload;
      } else {
        sub.items.push(payload);
        selectedItemIndex = sub.items.length - 1;
      }

      fillAdminScreen();
    }

    function deleteItem() {
      const sub = getSelectedSubtopic();
      if (!sub || selectedItemIndex < 0) return;
      if (!confirm('Excluir item selecionado?')) return;

      sub.items.splice(selectedItemIndex, 1);
      selectedItemIndex = -1;
      fillAdminScreen();
    }

    function toggleItemFields() {
      const type = document.getElementById('itemType').value;
      document.getElementById('urlField').classList.toggle('hidden', type === 'folder');
      document.getElementById('folderField').classList.toggle('hidden', type !== 'folder');
    }

    function saveAllAdmin() {
      adminDraft.appName = document.getElementById('appNameInput').value.trim();
      adminDraft.primaryColor = document.getElementById('primaryColorInput').value.trim();

      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        if (res.success) {
          currentConfig = JSON.parse(JSON.stringify(adminDraft));
          loadDashboard();
          loadAudit();
        }
      }).saveConfigObject(adminDraft);
    }

    function reloadAdminData() {
      google.script.run.withSuccessHandler(data => {
        adminDraft = JSON.parse(JSON.stringify(data.config));
        currentConfig = JSON.parse(JSON.stringify(data.config));
        selectedCategoryId = null;
        selectedSubtopicId = null;
        selectedItemIndex = -1;
        fillAdminScreen();
        loadDashboard();
        loadAudit();
      }).getAdminData();
    }

    function restoreDefault() {
      if (!confirm('Restaurar padr√£o? Todos os dados ser√£o apagados.')) return;
      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        if (res.success) {
          reloadAdminData();
        }
      }).resetToDefault();
    }

    function undoLastChange() {
      google.script.run.withSuccessHandler(res => {
        alert(res.message);
        if (res.success) {
          reloadAdminData();
        }
      }).undoLastChange();
    }

    function loadAudit() {
      google.script.run.withSuccessHandler(logs => {
        const el = document.getElementById('auditList');
        if (!logs.length) {
          el.innerHTML = '<div class="list-item">Sem hist√≥rico recente</div>';
          return;
        }

        el.innerHTML = logs.map(l => {
          const date = new Date(l.timestamp);
          return `<div class="list-item"><span>${l.action} - ${date.toLocaleString('pt-BR')}</span><span class="muted">${l.email}</span></div>`;
        }).join('');
      }).getAuditLog(10);
    }

    function slugify(text) {
      return String(text || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'item';
    }

    window.onload = () => {
      loadInitialData();

      const modal = document.getElementById('modal');
      modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    };
  </script>
</body>
</html>
